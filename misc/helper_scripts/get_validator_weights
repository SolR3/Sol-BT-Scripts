#!/usr/bin/env python3

import argparse


KNOWN_COLDKEYS = {
    "5FuzgvtfbZWdKSRxyYVPAPYNaNnf9cMnpT7phL3s2T3Kkrzo": "Rizzo",
    "5DywxdtESjskgPZrDXL86qV44SpPgJuqs9X6noyJJwX9PaSD": "Rt21",
    "5HBtpwxuGNL1gwzwomwR7sjwUt8WXYSuWcLYN6f9KpTZkP4k": "OTF",
    "5E9fVY1jexCNVMjd2rdBsAxeamFGEMfzHcyTn2fHgdHeYc5p": "Yuma",
    "5FHxxe8ZKYaNmGcSLdG5ekxXeZDhQnk9cbpHdsJW8RunGpSs": "Kraken",
    "5Cu7NFMULPDkaQkr3nciUVMADvCfqtnjeuYrZpuoMXo6H8MY": "TAO.com",
    "5CMUVyexHFz68M5wtuuD8iQCgEMb8e8U2FpvQfWmoYST6dQo": "MUV",
}


def parse_args():
    parser = argparse.ArgumentParser()

    parser.add_argument(
        "netuid",
        type=int,
        help="The uid of the subnet.")

    parser.add_argument(
        "--threshold",
        type=float,
        default=0.0,
        help="The weight threshold above which to print the value. Defaults to 0.")
    
    parser.add_argument(
        "--diff",
        nargs=2,
        help="Diff the weights of two uids or hotkeys rather than printing out all weights.")

    return parser.parse_args()


def print_all_weights(owner_hotkey, owner_uid, threshold, metagraph):
    print(f"\nOwner:\n==========\n{owner_uid} - {owner_hotkey}\n\n")
    
    print("Weights:\n==========")
    for uid in range(metagraph.num_uids):
        if metagraph.validator_permit[uid]:
            if uid == owner_uid:
                name = "Owner"
            else:
                coldkey = metagraph.coldkeys[uid]
                name = KNOWN_COLDKEYS.get(coldkey)

            vtrust = metagraph.Tv[uid]
            updated = metagraph.block - metagraph.last_update[uid]
            weights = [(i, float(w)) for i, w in enumerate(metagraph.weights[uid]) if w > threshold]

            if name:
                print(f"{name}:")
            print(f"{uid} - {metagraph.hotkeys[uid]} (Weights: {len(weights)}  vT: {vtrust:.3f}  U: {updated})")
            print(weights)
            print("")


def print_weight_diffs(uid_a, uid_b, threshold, metagraph):
    vtrust_a = metagraph.Tv[uid_a]
    vtrust_b = metagraph.Tv[uid_b]
    updated_a = metagraph.block - metagraph.last_update[uid_a]
    updated_b = metagraph.block - metagraph.last_update[uid_b]

    print("Hotkeys:\n=========")
    print(f"{uid_a:<3} - {metagraph.hotkeys[uid_a]} (vT: {vtrust_a:.3f}  U: {updated_a})")
    print(f"{uid_b:<3} - {metagraph.hotkeys[uid_b]} (vT: {vtrust_b:.3f}  U: {updated_b})")
    print("")

    weight_diffs = metagraph.weights[uid_a] - metagraph.weights[uid_b]
    weight_diffs = [(i, float(w)) for i, w in enumerate(weight_diffs) if abs(w) > threshold]

    print("Weight Diffs:\n==============")
    print(f"{len(weight_diffs)} differences\n")
    for uid, weight_diff in weight_diffs:
        weight_a = metagraph.weights[uid_a][uid]
        weight_b = metagraph.weights[uid_b][uid]
        print(f"{uid}:")
        print(f"{weight_diff}  ({weight_a} - {weight_b})")
        print("")


def get_uids(diff_a, diff_b, metagraph):
    try:
        uid_a = int(diff_a)
    except ValueError:
        uid_a = metagraph.hotkeys.index(diff_a)

    try:
        uid_b = int(diff_b)
    except ValueError:
        uid_b = metagraph.hotkeys.index(diff_b)

    return uid_a, uid_b


def main():
    import bittensor

    args = parse_args()

    with bittensor.Subtensor() as subtensor:
        owner_hotkey = subtensor.get_subnet_owner_hotkey(args.netuid)
        owner_uid = subtensor.get_uid_for_hotkey_on_subnet(owner_hotkey, args.netuid)
        metagraph = subtensor.metagraph(args.netuid, lite=False)

    if args.diff:
        uids = get_uids(*args.diff, metagraph)
        print_weight_diffs(*uids, args.threshold, metagraph)
    else:
        print_all_weights(owner_hotkey, owner_uid, args.threshold, metagraph)


if __name__ == "__main__":
    main()
